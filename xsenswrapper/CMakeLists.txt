# Copyright: (C) 2016 iCub Facility - Fondazione Istituto Italiano di Tecnologia
# Authors: Francesco Romano <francesco.romano@iit.it>
# CopyPolicy: Released under the terms of the GNU LGPL v2.0+

# For every system generate thrift libraries
yarp_idl_to_dir("${CMAKE_CURRENT_SOURCE_DIR}/thrift/XsensFrame.thrift" "${CMAKE_CURRENT_BINARY_DIR}/autogenerated/data" THRIFT_SOURCES THRIFT_HEADERS THRIFT_INCLUDE_DIRS)
yarp_idl_to_dir("${CMAKE_CURRENT_SOURCE_DIR}/thrift/XsensDriverService.thrift" "${CMAKE_CURRENT_BINARY_DIR}/autogenerated/services" THRIFT_SERVICE_SOURCES THRIFT_SERVICE_HEADERS THRIFT_SERVICE_INCLUDE_DIRS)

#set(CMAKE_WINDOWS_EXPORT_ALL_SYMBOLS ON)
add_library(xsens_mvn_idl STATIC ${THRIFT_SOURCES} ${THRIFT_HEADERS}
                          ${THRIFT_SERVICE_SOURCES} ${THRIFT_SERVICE_HEADERS})
target_include_directories(xsens_mvn_idl PUBLIC ${THRIFT_INCLUDE_DIRS}
                                                ${THRIFT_SERVICE_INCLUDE_DIRS})
target_include_directories(xsens_mvn_idl SYSTEM PUBLIC ${YARP_INCLUDE_DIRS})
target_link_libraries(xsens_mvn_idl YARP::YARP_OS)

if (${XsensXME_FOUND})
  YARP_PREPARE_PLUGIN(xsens_mvn_wrapper TYPE yarp::dev::XsensMVNWrapper
                                        INCLUDE XsensMVNWrapper.h
                                        CATEGORY device)

  if(ENABLE_xsens_mvn_wrapper)

    set(PLUGIN_SOURCES "${CMAKE_CURRENT_SOURCE_DIR}/src/XsensMVNWrapper.cpp")

    set(PLUGIN_HEADERS "${CMAKE_CURRENT_SOURCE_DIR}/include/XsensMVNWrapper.h")
    
    yarp_add_plugin(xsens_mvn_wrapper ${PLUGIN_SOURCES} ${PLUGIN_HEADERS})
    
    target_link_libraries(xsens_mvn_wrapper YARP::YARP_OS YARP::YARP_dev YARP::YARP_sig xsens_mvn_idl yarp_experimental)
    target_include_directories(xsens_mvn_wrapper SYSTEM PUBLIC ${YARP_INCLUDE_DIRS})
    target_include_directories(xsens_mvn_wrapper PUBLIC "${CMAKE_CURRENT_SOURCE_DIR}/include")
    
    target_compile_features(xsens_mvn_wrapper PRIVATE cxx_lambdas)

    yarp_install(TARGETS xsens_mvn_wrapper
           COMPONENT runtime
           LIBRARY DESTINATION ${YARP_DYNAMIC_PLUGINS_INSTALL_DIR}
           ARCHIVE DESTINATION ${YARP_STATIC_PLUGINS_INSTALL_DIR})
    yarp_install(FILES "${CMAKE_CURRENT_SOURCE_DIR}/conf/xsens_mvn_wrapper.ini"  DESTINATION ${YARP_PLUGIN_MANIFESTS_INSTALL_DIR})

  endif()
endif()
